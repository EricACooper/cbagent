#!/usr/bin/env python

import logging
import logging.config
import time
import sys
import signal
import multiprocessing
from optparse import OptionParser

from metadata.visit import main as visit, VISIT_ENTRY_FUNCS, retrieve_meta
import libcbtop.visit_cb as vc
import libcbtop.paint as pt

USAGE = """./%prog HOST [options]

Monitor a couchbase cluster.

Examples:
    ./%prog                     -- defaults to 127.0.0.1
    ./%prog 10.2.1.65
    ./%prog 10.2.1.65 -i 4"""

HOST = "127.0.0.1"


def handle_signal(signum, frame):
    """
    Handles registered signals and exit.
    """
    logging.info("received signal %s, aborting" % signum)

    pt.exit_fullscreen()

    global ctl
    ctl["run_ok"] = False


def usage():
    print USAGE
    sys.exit(-1)

def main(ctl, server, itv, dbhost, db, port=8091, path="/pools/default"):

    vc.store = vc.SerieslyStore(dbhost, db)
    vc.tbl.set_ftr("Last Update: %time")
    pt.enter_fullscreen()

    mc_proc = multiprocessing.Process(target=vc.mc_worker,
                                      args=(vc.mc_jobs, ctl))
    mc_proc.daemon = True
    mc_proc.start()

    visit_entry_func = VISIT_ENTRY_FUNCS.copy()
    visit_entry_func["collect_mc_stats"] = vc.collect_mc_stats

    while ctl["run_ok"]:

        visit(server, port, path,
              {"fast": vc.store_fast,
               "slow": vc.store_slow},
              {"url_before": vc.url_before,
               "url_after": vc.url_after},
              retrieve_funcs={"retrieve_data": vc.retrieve_data,
                              "retrieve_meta": retrieve_meta},
              entry_funcs=visit_entry_func, ctl=ctl)

        pt.paint(vc.tbl)
        logging.info("sleep for %s seconds" % itv)
        time.sleep(itv)

if __name__ == "__main__":

    signal.signal(signal.SIGINT, handle_signal)

    logging.config.fileConfig("logging.conf")

    parser = OptionParser(usage=USAGE)
    parser.add_option("-i", "--itv", dest="itv", default="1",
                      help="stats polling interval (seconds)")
    parser.add_option("-d", "--database", dest="db", default="cbtop",
                      help="seriesly database to store time series data")
    parser.add_option("-s", "--dbhost", dest="dbhost", default="localhost",
                      help="host where seriesly is located")
    options, args = parser.parse_args()

    if len(args) > 0:
        _server = args[0]
    else:
        _server = HOST

    try:
        _itv = int(options.itv)
    except ValueError, e:
        logging.error("invalid polling interval: %s" % options.itv)
        usage()

    _dbhost = options.dbhost
    _db = options.db

    ctl = {"run_ok": True}
    main(ctl, _server, _itv, _dbhost, _db)